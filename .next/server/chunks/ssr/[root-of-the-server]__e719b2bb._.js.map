{"version":3,"sources":["../../../../node_modules/next/src/build/webpack/loaders/next-flight-loader/server-reference.ts","../../../../node_modules/next/src/build/webpack/loaders/next-flight-loader/action-validate.ts","../../../../src/lib/rules/classification-utils.ts","../../../../src/lib/rules/engine.ts","../../../../src/lib/actions/rules.ts","../../../../.next-internal/server/app/%28dashboard%29/settings/rules/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["/* eslint-disable import/no-extraneous-dependencies */\nexport { registerServerReference } from 'react-server-dom-webpack/server'\n","// This function ensures that all the exported values are valid server actions,\n// during the runtime. By definition all actions are required to be async\n// functions, but here we can only check that they are functions.\nexport function ensureServerEntryExports(actions: any[]) {\n  for (let i = 0; i < actions.length; i++) {\n    const action = actions[i]\n    if (typeof action !== 'function') {\n      throw new Error(\n        `A \"use server\" file can only export async functions, found ${typeof action}.\\nRead more: https://nextjs.org/docs/messages/invalid-use-server-value`\n      )\n    }\n  }\n}\n","import type { Rule, AliasAssets } from \"@/lib/db/schema\";\n\nexport function normalizeForMatch(text: string): string {\n  return text\n    .toUpperCase()\n    .normalize(\"NFD\")\n    .replace(/[\\u0300-\\u036f]/g, \"\")\n    .replace(/\\s+/g, \" \")\n    .trim();\n}\n\nexport function splitKeyExpressions(input?: string | null): string[] {\n  if (!input) return [];\n  return input\n    .split(\";\")\n    .map((expr) => expr.trim())\n    .filter((expr) => expr.length > 0);\n}\n\nexport function findMatchedExpression(haystack: string, expressions: string[]): string | null {\n  for (const expr of expressions) {\n    if (haystack.includes(expr)) {\n      return expr;\n    }\n  }\n  return null;\n}\n\nexport function evaluateRuleMatch(keyDesc: string, rule: Rule) {\n  const haystack = normalizeForMatch(keyDesc);\n  const positives = splitKeyExpressions(rule.keyWords || rule.keywords || \"\");\n  const negatives = splitKeyExpressions(rule.keyWordsNegative);\n\n  const normalizedPositives = positives.map(normalizeForMatch);\n  const normalizedNegatives = negatives.map(normalizeForMatch);\n\n  const positiveMatch = findMatchedExpression(haystack, normalizedPositives);\n  const negativeMatch = findMatchedExpression(haystack, normalizedNegatives);\n\n  return {\n    positiveMatch,\n    negativeMatch,\n    isMatch: Boolean(positiveMatch) && !negativeMatch\n  };\n}\n\nexport function evaluateAliasMatch(keyDesc: string, alias: AliasAssets) {\n  const haystack = normalizeForMatch(keyDesc);\n  const expressions = splitKeyExpressions(alias.keyWordsAlias || \"\");\n  const normalized = expressions.map(normalizeForMatch);\n  const matched = findMatchedExpression(haystack, normalized);\n  return {\n    matched,\n    isMatch: Boolean(matched)\n  };\n}\n","// Rules Engine for AI-powered transaction categorization with confidence levels\n\nimport type { Rule, Transaction } from \"@/lib/db/schema\";\nimport { evaluateRuleMatch } from \"./classification-utils\";\n\nexport interface RuleMatch {\n  ruleId: string;\n  type: \"Despesa\" | \"Receita\";\n  fixVar: \"Fixo\" | \"Variável\";\n  category1: string;\n  category2?: string;\n  category3?: string;\n  priority: number;\n  strict: boolean;\n  isSystem: boolean;\n  matchedKeyword?: string;\n}\n\nexport interface CategorizationResult {\n  needsReview: boolean;\n  matches: RuleMatch[];\n  appliedRule?: RuleMatch;\n  confidence: number;\n  reason?: string;\n}\n\nfunction normalizeForMatch(text: string): string {\n  return text\n    .toUpperCase()\n    .normalize(\"NFD\")\n    .replace(/[\\u0300-\\u036f]/g, \"\")\n    .replace(/\\s+/g, \" \")\n    .trim();\n}\n\nexport interface UserSettings {\n  autoConfirmHighConfidence?: boolean;\n  confidenceThreshold?: number;\n}\n\nexport function matchRules(descNorm: string, rules: Rule[], settings: UserSettings = {}): CategorizationResult {\n  const {\n    autoConfirmHighConfidence = false,\n    confidenceThreshold = 80\n  } = settings;\n\n  const haystack = normalizeForMatch(descNorm);\n  const matches: RuleMatch[] = [];\n\n  const sortedRules = [...rules].sort((a, b) => (b.priority || 500) - (a.priority || 500));\n\n  for (const rule of sortedRules) {\n    if (!rule.keywords && !rule.keyWords) continue; // Skip rules without keywords\n\n    const keywordString = rule.keyWords || rule.keywords || \"\";\n    const keywords = keywordString\n      .split(\";\")\n      .map(k => normalizeForMatch(k))\n      .filter(k => k.length > 0);\n\n    const matchedKeyword = keywords.find(keyword => haystack.includes(keyword));\n\n    if (matchedKeyword) {\n      const match: RuleMatch = {\n        ruleId: rule.id,\n        type: rule.type || \"Despesa\",\n        fixVar: rule.fixVar || \"Variável\",\n        category1: rule.category1 || \"Outros\",\n        category2: rule.category2 || undefined,\n        category3: rule.category3 || undefined,\n        priority: rule.priority || 500,\n        strict: rule.strict || false,\n        isSystem: rule.isSystem || false,\n        matchedKeyword\n      };\n\n      if (rule.strict) {\n        return {\n          needsReview: false,\n          matches: [match],\n          appliedRule: match,\n          confidence: 100,\n          reason: \"Regra estrita aplicada automaticamente\"\n        };\n      }\n\n      matches.push(match);\n    }\n  }\n\n  if (matches.length === 0) {\n    return {\n      needsReview: true,\n      matches: [],\n      confidence: 0,\n      reason: \"Nenhuma regra encontrada\"\n    };\n  }\n\n  if (matches.length === 1) {\n    const match = matches[0];\n    const confidence = calculateConfidence(match);\n    const meetsThreshold = confidence >= confidenceThreshold;\n    const autoApply = autoConfirmHighConfidence && meetsThreshold;\n\n    return {\n      needsReview: !autoApply,\n      matches,\n      appliedRule: match,\n      confidence,\n      reason: autoApply\n        ? `Alta confianca (${confidence}%) - aplicado automaticamente`\n        : meetsThreshold\n          ? `Alta confianca (${confidence}%) - revisar (auto-confirm desativado)`\n          : `Confianca media (${confidence}%) - revisar`\n    };\n  }\n\n  const topMatches = matches.filter(m => m.priority === matches[0].priority);\n\n  if (topMatches.length === 1) {\n    const match = topMatches[0];\n    const confidence = Math.min(calculateConfidence(match) - 10, 85);\n    const meetsThreshold = confidence >= confidenceThreshold;\n    const autoApply = autoConfirmHighConfidence && meetsThreshold;\n\n    return {\n      needsReview: !autoApply,\n      matches,\n      appliedRule: match,\n      confidence,\n      reason: autoApply\n        ? `Multiplas regras mas prioridade clara (${confidence}%)`\n        : meetsThreshold\n          ? `Alta confianca (${confidence}%) - revisar (auto-confirm desativado)`\n          : `Multiplas regras (${confidence}%) - revisar`\n    };\n  }\n\n  return {\n    needsReview: true,\n    matches,\n    appliedRule: matches[0],\n    confidence: 50,\n    reason: `Conflito: ${matches.length} regras com mesma prioridade`\n  };\n}\n\nfunction calculateConfidence(match: RuleMatch): number {\n  let confidence = 70;\n  \n  if (match.isSystem) confidence += 10;\n  if (match.priority >= 800) confidence += 15;\n  else if (match.priority >= 600) confidence += 10;\n  else if (match.priority >= 500) confidence += 5;\n  \n  if (match.strict) confidence = 100;\n  \n  return Math.min(confidence, 100);\n}\n\nexport function categorizeTransaction(\n  descNorm: string,\n  rules: Rule[],\n  settings: UserSettings = {}\n): Partial<Transaction> & { confidence?: number } {\n  const result = matchRules(descNorm, rules, settings);\n  \n  if (result.appliedRule && !result.needsReview) {\n    const rule = result.appliedRule;\n    const isInterno = rule.category1 === \"Interno\";\n    \n    return {\n      type: rule.type,\n      fixVar: rule.fixVar,\n      category1: rule.category1 as any,\n      category2: rule.category2,\n      category3: rule.category3,\n      needsReview: false,\n      ruleIdApplied: rule.ruleId,\n      internalTransfer: isInterno,\n      excludeFromBudget: isInterno,\n      confidence: result.confidence\n    };\n  }\n\n  if (result.appliedRule && result.needsReview) {\n    const rule = result.appliedRule;\n    const isInterno = rule.category1 === \"Interno\";\n\n    return {\n      type: rule.type,\n      fixVar: rule.fixVar,\n      category1: rule.category1 as any,\n      category2: rule.category2,\n      category3: rule.category3,\n      needsReview: true,\n      ruleIdApplied: rule.ruleId,\n      internalTransfer: isInterno,\n      excludeFromBudget: isInterno,\n      confidence: result.confidence\n    };\n  }\n\n  return {\n    needsReview: true,\n    confidence: 0\n  };\n}\n\nexport function suggestKeyword(descNorm: string): string {\n  const parts = descNorm.split(\"--\");\n  if (parts.length > 0) {\n    const mainPart = parts[0].trim();\n    const words = mainPart.split(\" \").slice(0, 3).join(\" \");\n    return words;\n  }\n  return descNorm.slice(0, 30);\n}\n\nexport interface KeyDescMatchResult {\n  ruleId?: string;\n  leafId?: string;\n  matchedExpression?: string;\n}\n\nexport function classifyByKeyDesc(keyDesc: string, rules: Rule[]): KeyDescMatchResult {\n  for (const rule of rules.filter(r => r.active !== false && (r.keyWords || r.keywords))) {\n    const result = evaluateRuleMatch(keyDesc, rule);\n    if (result.isMatch) {\n      return {\n        ruleId: rule.id,\n        leafId: rule.leafId || undefined,\n        matchedExpression: result.positiveMatch || undefined\n      };\n    }\n  }\n\n  return {};\n}\n\nexport const AI_SEED_RULES = [\n  {\n    name: \"Interno\",\n    keywords: \"AMEX - ZAHLUNG;ZAHLUNG ERHALTEN;PAGAMENTO AMEX;PAGAMENTO M&M;AMERICAN EXPRESS ZAHLUNG;DEUTSCHE KREDITBANK;LASTSCHRIFT\",\n    type: \"Despesa\" as const,\n    fixVar: \"Fixo\" as const,\n    category1: \"Interno\" as const,\n    category2: \"Transferencias\",\n    priority: 1000,\n    strict: true,\n    isSystem: true\n  },\n  {\n    name: \"Mercado\",\n    keywords: \"REWE;EDEKA;ALDI;LIDL;NETTO;NORMA;DM;DM-DROGERIE;ROSSMANN;MUELLER;MÜLLER;ASIA MARKT;BACKSTUBE;BAECKEREI;IHLE;WUENSCHE;FRUCHTWERK\",\n    type: \"Despesa\" as const,\n    fixVar: \"Variável\" as const,\n    category1: \"Mercado\" as const,\n    category2: \"Supermercado\",\n    priority: 900,\n    strict: true,\n    isSystem: true\n  }\n  // ... more seeds can be added later if needed\n];\n","\"use server\";\n\nimport { db } from \"@/lib/db\";\nimport { rules } from \"@/lib/db/schema\";\nimport { eq, desc } from \"drizzle-orm\";\nimport { auth } from \"@/auth\";\nimport { categorizeTransaction } from \"@/lib/rules/engine\";\nimport { revalidatePath } from \"next/cache\";\n\nexport async function getRules() {\n  const session = await auth();\n  if (!session?.user?.id) return [];\n\n  return await db.query.rules.findMany({\n    where: eq(rules.userId, session.user.id),\n    orderBy: [desc(rules.priority)]\n  });\n}\n\nexport async function testRuleCategorization(description: string) {\n  const session = await auth();\n  if (!session?.user?.id) return null;\n\n  const userRules = await getRules();\n  const result = categorizeTransaction(description, userRules);\n  \n  return result;\n}\n\nexport async function createRule(data: typeof rules.$inferInsert) {\n  const session = await auth();\n  if (!session?.user?.id) throw new Error(\"Unauthorized\");\n  \n  await db.insert(rules).values({\n    ...data,\n    userId: session.user.id\n  });\n  \n  revalidatePath(\"/rules\");\n}\n","export {getRules as '0098dadc982ce31f86c900227d53ab42740e48baaf'} from 'ACTIONS_MODULE0'\nexport {createRule as '403c284cc4c30894195431ad16bc5addcaadb17ed6'} from 'ACTIONS_MODULE0'\nexport {testRuleCategorization as '40dbc5236911bb8712ca108c1b9a5bb87de662f8b6'} from 'ACTIONS_MODULE0'\n"],"names":["registerServerReference","ensureServerEntryExports","actions","i","length","action","Error"],"mappings":"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","ignoreList":[0,1]}