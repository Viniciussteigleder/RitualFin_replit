
> rest-express@1.0.1 test:e2e
> playwright test


========================================
Rules Engine Unit Tests
Logic Contract: docs/LOGIC_CONTRACT.md
========================================

TC-001: Testing determinism...
  âœ“ TC-001 passed: Deterministic output
TC-002: Testing strict rule short-circuit...
  âœ“ TC-002 passed: Strict rule short-circuits correctly
TC-003: Testing priority order...
  âœ“ TC-003 passed: Higher priority wins
TC-004: Testing negative keywords...
  âœ“ TC-004 passed: Negative keywords exclude correctly
TC-005: Testing Interno auto-flagging...
  âœ“ TC-005 passed: Interno auto-flags correctly
TC-006: Manual override preservation...
  âš  Note: Full test requires database integration
  âœ“ TC-006 skipped: Tested at integration level
TC-007: Testing conflict detection...
  âœ“ TC-007 passed: Conflict detection works
TC-008: Testing confidence threshold...
  âœ“ TC-008 passed: Confidence threshold respected
TC-009: Testing inactive rule handling...
  âœ“ TC-009 passed: Inactive rules ignored
TC-010: Testing negative keyword exclusion in matchRules...
  âœ“ TC-010 passed: matchRules respects negative keywords
EC-001: Testing empty keywords handling...
  âœ“ EC-001 passed: Empty keywords handled
EC-002: Testing special characters...
  âœ“ EC-002 passed: Special characters work
EC-003: Testing unicode normalization...
  âœ“ EC-003 passed: Unicode normalization works
EC-004: Testing case insensitivity...
  âœ“ EC-004 passed: Case insensitivity works

========================================
Results: 14 passed, 0 failed
========================================


Running 14 tests using 4 workers

[1A[2K[1/14] [chromium] â€º tests/auth_harden.spec.ts:8:1 â€º Auth route does not immediately error
[1A[2K[2/14] [chromium] â€º tests/auth-flow.spec.ts:21:3 â€º Auth Flow â€º should redirect to login when accessing protected route while logged out
[1A[2K[3/14] [chromium] â€º tests/auth-flow.spec.ts:3:3 â€º Auth Flow â€º should load login page and show Google sign-in button
[1A[2K[4/14] [chromium] â€º tests/auth_harden.spec.ts:2:1 â€º Auth debug endpoint is not exposed in production
[1A[2K[5/14] [chromium] â€º tests/auth-flow.spec.ts:30:3 â€º Auth Flow â€º health endpoint should return OK status
[1A[2K[6/14] [chromium] â€º tests/auth-flow.spec.ts:40:3 â€º Application Health â€º homepage should load
[1A[2K[7/14] [chromium] â€º tests/auth-flow.spec.ts:50:3 â€º Application Health â€º should have no console errors on login page
[1A[2K[8/14] [chromium] â€º tests/auth.spec.ts:3:3 â€º Authentication â€º login page renders and shows error on missing config
[1A[2K[9/14] [chromium] â€º tests/auth.spec.ts:20:3 â€º Authentication â€º signup and login flow
[1A[2K[10/14] [chromium] â€º tests/ingestion.spec.ts:18:3 â€º Ingestion Flow â€º upload CSV, preview, commit and rollback
[1A[2K[WebServer] [31m[auth][error][0m CredentialsSignin: Read more at https://errors.authjs.dev#credentialssignin

[1A[2K[WebServer]     at ad (/Users/viniciussteigleder/Documents/Web apps - vide coding/RitualFin_replit_local/RitualFin_replit/.next/server/chunks/_2500f2ad._.js:404:40935)
[WebServer]     at process.processTicksAndRejections (node:internal/process/task_queues:103:5)
[WebServer]     at async ax (/Users/viniciussteigleder/Documents/Web apps - vide coding/RitualFin_replit_local/RitualFin_replit/.next/server/chunks/_2500f2ad._.js:404:50360)
[WebServer]     at async aw (/Users/viniciussteigleder/Documents/Web apps - vide coding/RitualFin_replit_local/RitualFin_replit/.next/server/chunks/_2500f2ad._.js:404:54610)
[WebServer]     at async rU.do (/Users/viniciussteigleder/Documents/Web apps - vide coding/RitualFin_replit_local/RitualFin_replit/node_modules/next/dist/compiled/next-server/app-route-turbo.runtime.prod.js:5:20169)
[WebServer]     at async rU.handle (/Users/viniciussteigleder/Documents/Web apps - vide coding/RitualFin_replit_local/RitualFin_replit/node_modules/next/dist/compiled/next-server/app-route-turbo.runtime.prod.js:5:24949)
[WebServer]     at async u (/Users/viniciussteigleder/Documents/Web apps - vide coding/RitualFin_replit_local/RitualFin_replit/.next/server/chunks/[root-of-the-server]__6ea5f74b._.js:1:4815)
[WebServer]     at async rU.handleResponse (/Users/viniciussteigleder/Documents/Web apps - vide coding/RitualFin_replit_local/RitualFin_replit/node_modules/next/dist/compiled/next-server/app-route-turbo.runtime.prod.js:1:101467)
[WebServer]     at async d (/Users/viniciussteigleder/Documents/Web apps - vide coding/RitualFin_replit_local/RitualFin_replit/.next/server/chunks/[root-of-the-server]__6ea5f74b._.js:1:5856)
[WebServer]     at async Module.C (/Users/viniciussteigleder/Documents/Web apps - vide coding/RitualFin_replit_local/RitualFin_replit/.next/server/chunks/[root-of-the-server]__6ea5f74b._.js:1:6934)

[1A[2K[11/14] [chromium] â€º tests/screens.spec.ts:3:1 â€º Routes: protected screens redirect when logged out
[1A[2K[12/14] [chromium] â€º tests/screens.spec.ts:14:1 â€º Routes: authenticated screens load without server errors
[1A[2K[WebServer] [Dashboard] getDashboardData error: error: COALESCE types text and category_1 cannot be matched
[WebServer]     at async (.next/server/chunks/ssr/_15b86a0f._.js:442:37059)
[WebServer]     at async p (.next/server/chunks/ssr/[root-of-the-server]__7429e72a._.js:1:7535)
[WebServer]     at async E (.next/server/chunks/ssr/_a5119bcf._.js:1:9230) {
[WebServer]   length: [33m126[39m,
[WebServer]   severity: [32m'ERROR'[39m,
[WebServer]   code: [32m'42804'[39m,
[WebServer]   detail: [90mundefined[39m,
[WebServer]   hint: [90mundefined[39m,
[WebServer]   position: [32m'38'[39m,
[WebServer]   internalPosition: [90mundefined[39m,
[WebServer]   internalQuery: [90mundefined[39m,
[WebServer]   where: [90mundefined[39m,
[WebServer]   schema: [90mundefined[39m,
[WebServer]   table: [90mundefined[39m,
[WebServer]   column: [90mundefined[39m,
[WebServer]   dataType: [90mundefined[39m,
[WebServer]   constraint: [90mundefined[39m,
[WebServer]   file: [32m'parse_coerce.c'[39m,
[WebServer]   line: [32m'1416'[39m,
[WebServer]   routine: [32m'select_common_type'[39m
[WebServer] }

[1A[2K[13/14] [chromium] â€º tests/screenshot.spec.ts:18:3 â€º Screenshot Ingestion â€º upload screenshot with mocked OCR and verify enrichment
[1A[2K[WebServer] [Dashboard] Missing metrics, using fallback values

[1A[2K[WebServer] [Dashboard] getDashboardData error: error: COALESCE types text and category_1 cannot be matched
[WebServer]     at async (.next/server/chunks/ssr/_15b86a0f._.js:442:37059)
[WebServer]     at async p (.next/server/chunks/ssr/[root-of-the-server]__7429e72a._.js:1:7535)
[WebServer]     at async E (.next/server/chunks/ssr/_a5119bcf._.js:1:9230) {
[WebServer]   length: [33m126[39m,
[WebServer]   severity: [32m'ERROR'[39m,
[WebServer]   code: [32m'42804'[39m,
[WebServer]   detail: [90mundefined[39m,
[WebServer]   hint: [90mundefined[39m,
[WebServer]   position: [32m'38'[39m,
[WebServer]   internalPosition: [90mundefined[39m,
[WebServer]   internalQuery: [90mundefined[39m,
[WebServer]   where: [90mundefined[39m,
[WebServer]   schema: [90mundefined[39m,
[WebServer]   table: [90mundefined[39m,
[WebServer]   column: [90mundefined[39m,
[WebServer]   dataType: [90mundefined[39m,
[WebServer]   constraint: [90mundefined[39m,
[WebServer]   file: [32m'parse_coerce.c'[39m,
[WebServer]   line: [32m'1416'[39m,
[WebServer]   routine: [32m'select_common_type'[39m
[WebServer] }
[WebServer] [Dashboard] Missing metrics, using fallback values

[1A[2K[WebServer] [Dashboard] getDashboardData error: error: COALESCE types text and category_1 cannot be matched
[WebServer]     at async (.next/server/chunks/ssr/_15b86a0f._.js:442:37059)
[WebServer]     at async p (.next/server/chunks/ssr/[root-of-the-server]__7429e72a._.js:1:7535)
[WebServer]     at async E (.next/server/chunks/ssr/_a5119bcf._.js:1:9230) {
[WebServer]   length: [33m126[39m,
[WebServer]   severity: [32m'ERROR'[39m,
[WebServer]   code: [32m'42804'[39m,
[WebServer]   detail: [90mundefined[39m,
[WebServer]   hint: [90mundefined[39m,
[WebServer]   position: [32m'38'[39m,
[WebServer]   internalPosition: [90mundefined[39m,
[WebServer]   internalQuery: [90mundefined[39m,
[WebServer]   where: [90mundefined[39m,
[WebServer]   schema: [90mundefined[39m,
[WebServer]   table: [90mundefined[39m,
[WebServer]   column: [90mundefined[39m,
[WebServer]   dataType: [90mundefined[39m,
[WebServer]   constraint: [90mundefined[39m,
[WebServer]   file: [32m'parse_coerce.c'[39m,
[WebServer]   line: [32m'1416'[39m,
[WebServer]   routine: [32m'select_common_type'[39m
[WebServer] }

[1A[2K[WebServer] [Dashboard] Missing metrics, using fallback values

[1A[2K[WebServer] [Dashboard] getDashboardData error: error: COALESCE types text and category_1 cannot be matched
[WebServer]     at async (.next/server/chunks/ssr/_15b86a0f._.js:442:37059)
[WebServer]     at async p (.next/server/chunks/ssr/[root-of-the-server]__7429e72a._.js:1:7535)
[WebServer]     at async E (.next/server/chunks/ssr/_a5119bcf._.js:1:9230) {
[WebServer]   length: [33m126[39m,
[WebServer]   severity: [32m'ERROR'[39m,
[WebServer]   code: [32m'42804'[39m,
[WebServer]   detail: [90mundefined[39m,
[WebServer]   hint: [90mundefined[39m,
[WebServer]   position: [32m'38'[39m,
[WebServer]   internalPosition: [90mundefined[39m,
[WebServer]   internalQuery: [90mundefined[39m,
[WebServer]   where: [90mundefined[39m,
[WebServer]   schema: [90mundefined[39m,
[WebServer]   table: [90mundefined[39m,
[WebServer]   column: [90mundefined[39m,
[WebServer]   dataType: [90mundefined[39m,
[WebServer]   constraint: [90mundefined[39m,
[WebServer]   file: [32m'parse_coerce.c'[39m,
[WebServer]   line: [32m'1416'[39m,
[WebServer]   routine: [32m'select_common_type'[39m
[WebServer] }

[1A[2K[WebServer] [Dashboard] getDashboardData error: error: COALESCE types text and category_1 cannot be matched
[WebServer]     at async (.next/server/chunks/ssr/_15b86a0f._.js:442:37059)
[WebServer]     at async p (.next/server/chunks/ssr/[root-of-the-server]__7429e72a._.js:1:7535)
[WebServer]     at async E (.next/server/chunks/ssr/_a5119bcf._.js:1:9230) {
[WebServer]   length: [33m126[39m,
[WebServer]   severity: [32m'ERROR'[39m,
[WebServer]   code: [32m'42804'[39m,
[WebServer]   detail: [90mundefined[39m,
[WebServer]   hint: [90mundefined[39m,
[WebServer]   position: [32m'38'[39m,
[WebServer]   internalPosition: [90mundefined[39m,
[WebServer]   internalQuery: [90mundefined[39m,
[WebServer]   where: [90mundefined[39m,
[WebServer]   schema: [90mundefined[39m,
[WebServer]   table: [90mundefined[39m,
[WebServer]   column: [90mundefined[39m,
[WebServer]   dataType: [90mundefined[39m,
[WebServer]   constraint: [90mundefined[39m,
[WebServer]   file: [32m'parse_coerce.c'[39m,
[WebServer]   line: [32m'1416'[39m,
[WebServer]   routine: [32m'select_common_type'[39m
[WebServer] }

[1A[2K[WebServer] [Dashboard] Missing metrics, using fallback values

[1A[2K[WebServer] [Dashboard] Missing metrics, using fallback values

[1A[2K[WebServer] OpenAI Categorization Error: TypeError: Cannot read properties of undefined (reading 'completions')
[WebServer]     at bV (.next/server/chunks/ssr/_31f7cb5e._.js:5:11700)
[WebServer]     at u (.next/server/chunks/ssr/_31f7cb5e._.js:8:10875)
[WebServer]     at async v (.next/server/chunks/ssr/_31f7cb5e._.js:8:12675)
[WebServer]     at async u (.next/server/chunks/ssr/_f0af07a0._.js:1:5213)
[WebServer]     at async m (.next/server/chunks/ssr/_e3a8dd3d._.js:1:7509)

[1A[2K[WebServer] [31m[1mâ¨¯[22m[39m error: invalid input value for enum transaction_type: "open"
[WebServer]     at async u (.next/server/chunks/ssr/_31f7cb5e._.js:8:12260)
[WebServer]     at async v (.next/server/chunks/ssr/_31f7cb5e._.js:8:12675)
[WebServer]     at async u (.next/server/chunks/ssr/_f0af07a0._.js:1:5213)
[WebServer]     at async m (.next/server/chunks/ssr/_e3a8dd3d._.js:1:7509) {
[WebServer]   length: [33m141[39m,
[WebServer]   severity: [32m'ERROR'[39m,
[WebServer]   code: [32m'22P02'[39m,
[WebServer]   detail: [90mundefined[39m,
[WebServer]   hint: [90mundefined[39m,
[WebServer]   position: [90mundefined[39m,
[WebServer]   internalPosition: [90mundefined[39m,
[WebServer]   internalQuery: [90mundefined[39m,
[WebServer]   where: [32m"unnamed portal parameter $13 = '...'"[39m,
[WebServer]   schema: [90mundefined[39m,
[WebServer]   table: [90mundefined[39m,
[WebServer]   column: [90mundefined[39m,
[WebServer]   dataType: [90mundefined[39m,
[WebServer]   constraint: [90mundefined[39m,
[WebServer]   file: [32m'enum.c'[39m,
[WebServer]   line: [32m'129'[39m,
[WebServer]   routine: [32m'enum_in'[39m,
[WebServer]   digest: [32m'1815325352'[39m
[WebServer] }

[1A[2K[WebServer] Screenshot upload error: TypeError: Cannot read properties of undefined (reading 'toISOString')
[WebServer]     at c (.next/server/chunks/ssr/_31f7cb5e._.js:1:7671)
[WebServer]     at n (.next/server/chunks/ssr/_f0af07a0._.js:1:11704)
[WebServer]     at async m (.next/server/chunks/ssr/_e3a8dd3d._.js:1:7509)
[WebServer]     at async p (.next/server/chunks/ssr/_e3a8dd3d._.js:2:2712)

[1A[2K  1) [chromium] â€º tests/screenshot.spec.ts:18:3 â€º Screenshot Ingestion â€º upload screenshot with mocked OCR and verify enrichment 

    Error: [2mexpect([22m[31mlocator[39m[2m).[22mtoContainText[2m([22m[32mexpected[39m[2m)[22m failed

    Locator: locator('form').getByText(/Screenshot uploaded and parsed successfully!|Error:|Failed to run OCR\\./)
    Expected substring: [32m"Screenshot uploaded and parsed successfully!"[39m
    Received string:    [31m"Error: Cannot read properties of undefined (reading 'toISOString')"[39m
    Timeout: 5000ms

    Call log:
    [2m  - Expect "toContainText" with timeout 5000ms[22m
    [2m  - waiting for locator('form').getByText(/Screenshot uploaded and parsed successfully!|Error:|Failed to run OCR\\./)[22m
    [2m    9 Ã— locator resolved to <div class="p-3 rounded-md text-sm bg-destructive/10 text-destructive">Error: Cannot read properties of undefined (readiâ€¦</div>[22m
    [2m      - unexpected value "Error: Cannot read properties of undefined (reading 'toISOString')"[22m


      33 |     const message = page.locator("form").getByText(/Screenshot uploaded and parsed successfully!|Error:|Failed to run OCR\\./);
      34 |     await expect(message).toBeVisible({ timeout: 60000 });
    > 35 |     await expect(message).toContainText("Screenshot uploaded and parsed successfully!");
         |                           ^
      36 |     
      37 |     // Verify in transactions
      38 |     await page.goto('/transactions');
        at /Users/viniciussteigleder/Documents/Web apps - vide coding/RitualFin_replit_local/RitualFin_replit/tests/screenshot.spec.ts:35:27

    Error Context: test-results/screenshot-Screenshot-Inge-d82c2-d-OCR-and-verify-enrichment-chromium/error-context.md


[1A[2K[WebServer] [31m[1mâ¨¯[22m[39m error: invalid input value for enum category_1: "OPEN"
[WebServer]     at async (.next/server/chunks/ssr/_15b86a0f._.js:442:37059)
[WebServer]     at async l (.next/server/chunks/ssr/_bf1d19dc._.js:1:4681)
[WebServer]     at async s (.next/server/chunks/ssr/[root-of-the-server]__520ef55b._.js:1:13260) {
[WebServer]   length: [33m134[39m,
[WebServer]   severity: [32m'ERROR'[39m,
[WebServer]   code: [32m'22P02'[39m,
[WebServer]   detail: [90mundefined[39m,
[WebServer]   hint: [90mundefined[39m,
[WebServer]   position: [90mundefined[39m,
[WebServer]   internalPosition: [90mundefined[39m,
[WebServer]   internalQuery: [90mundefined[39m,
[WebServer]   where: [32m"unnamed portal parameter $2 = '...'"[39m,
[WebServer]   schema: [90mundefined[39m,
[WebServer]   table: [90mundefined[39m,
[WebServer]   column: [90mundefined[39m,
[WebServer]   dataType: [90mundefined[39m,
[WebServer]   constraint: [90mundefined[39m,
[WebServer]   file: [32m'enum.c'[39m,
[WebServer]   line: [32m'129'[39m,
[WebServer]   routine: [32m'enum_in'[39m,
[WebServer]   digest: [32m'2490965190'[39m
[WebServer] }

[1A[2K[14/14] [chromium] â€º tests/smoke-test.spec.ts:2:1 â€º app loads without runtime errors
[1A[2K[chromium] â€º tests/smoke-test.spec.ts:2:1 â€º app loads without runtime errors
âœ… Login page loads successfully

[1A[2K[WebServer] [Dashboard] getDashboardData error: error: COALESCE types text and category_1 cannot be matched
[WebServer]     at async (.next/server/chunks/ssr/_15b86a0f._.js:442:37059)
[WebServer]     at async p (.next/server/chunks/ssr/[root-of-the-server]__7429e72a._.js:1:7535)
[WebServer]     at async E (.next/server/chunks/ssr/_a5119bcf._.js:1:9230) {
[WebServer]   length: [33m126[39m,
[WebServer]   severity: [32m'ERROR'[39m,
[WebServer]   code: [32m'42804'[39m,
[WebServer]   detail: [90mundefined[39m,
[WebServer]   hint: [90mundefined[39m,
[WebServer]   position: [32m'38'[39m,
[WebServer]   internalPosition: [90mundefined[39m,
[WebServer]   internalQuery: [90mundefined[39m,
[WebServer]   where: [90mundefined[39m,
[WebServer]   schema: [90mundefined[39m,
[WebServer]   table: [90mundefined[39m,
[WebServer]   column: [90mundefined[39m,
[WebServer]   dataType: [90mundefined[39m,
[WebServer]   constraint: [90mundefined[39m,
[WebServer]   file: [32m'parse_coerce.c'[39m,
[WebServer]   line: [32m'1416'[39m,
[WebServer]   routine: [32m'select_common_type'[39m
[WebServer] }

[1A[2K[WebServer] [Dashboard] Missing metrics, using fallback values

[1A[2KFinal URL: http://localhost:3001/

[1A[2Kâœ… No schema errors detected

[1A[2K  2) [chromium] â€º tests/screens.spec.ts:14:1 â€º Routes: authenticated screens load without server errors 

    Error: [2mexpect([22m[31mlocator[39m[2m).[22mtoHaveCount[2m([22m[32mexpected[39m[2m)[22m failed

    Locator:  locator('text=Application error')
    Expected: [32m0[39m
    Received: [31m1[39m
    Timeout:  5000ms

    Call log:
    [2m  - Expect "toHaveCount" with timeout 5000ms[22m
    [2m  - waiting for locator('text=Application error')[22m
    [2m    9 Ã— locator resolved to 1 element[22m
    [2m      - unexpected value "1"[22m


      46 |     await page.waitForLoadState("networkidle");
      47 |     await expect(page.locator("text=Internal Server Error")).toHaveCount(0);
    > 48 |     await expect(page.locator("text=Application error")).toHaveCount(0);
         |                                                          ^
      49 |   }
      50 |
      51 |   const health = await page.request.get("/api/health");
        at /Users/viniciussteigleder/Documents/Web apps - vide coding/RitualFin_replit_local/RitualFin_replit/tests/screens.spec.ts:48:58

    Error Context: test-results/screens-Routes-authenticat-f3875--load-without-server-errors-chromium/error-context.md


[1A[2K  3) [chromium] â€º tests/ingestion.spec.ts:18:3 â€º Ingestion Flow â€º upload CSV, preview, commit and rollback 

    [31mTest timeout of 30000ms exceeded.[39m

    Error: [2mexpect([22m[31mlocator[39m[2m).[22mtoBeVisible[2m([22m[2m)[22m failed

    Locator: getByText('committed')
    Expected: visible
    Error: element(s) not found

    Call log:
    [2m  - Expect "toBeVisible" with timeout 60000ms[22m
    [2m  - waiting for getByText('committed')[22m


      28 |     
      29 |     // Should show committed status
    > 30 |     await expect(page.getByText('committed')).toBeVisible({ timeout: 60000 });
         |                                               ^
      31 |     
      32 |     // Verify in transactions
      33 |     await page.goto('/transactions');
        at /Users/viniciussteigleder/Documents/Web apps - vide coding/RitualFin_replit_local/RitualFin_replit/tests/ingestion.spec.ts:30:47

    Error Context: test-results/ingestion-Ingestion-Flow-u-2848a-preview-commit-and-rollback-chromium/error-context.md


[1A[2K  3 failed
    [chromium] â€º tests/ingestion.spec.ts:18:3 â€º Ingestion Flow â€º upload CSV, preview, commit and rollback 
    [chromium] â€º tests/screens.spec.ts:14:1 â€º Routes: authenticated screens load without server errors 
    [chromium] â€º tests/screenshot.spec.ts:18:3 â€º Screenshot Ingestion â€º upload screenshot with mocked OCR and verify enrichment 
  11 passed (51.8s)
